{% extends "base.html" %}

{% block title %}OI Changes - Top Active{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="text-primary mb-0">
                    <i class="fas fa-chart-line me-2"></i>OI Changes - Top Active
                </h2>
                <div class="text-muted">
                    <i class="fas fa-clock me-1"></i>
                    Last Updated: <span id="lastUpdated">{{ format_ist_time(current_time) }}</span>
                </div>
            </div>
        </div>
    </div>

    {% if error %}
    <div class="alert alert-warning" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
    </div>
    {% endif %}

    <!-- Refresh Button -->
    <div class="row mb-3">
        <div class="col-12">
            <button class="btn btn-success" onclick="refreshData()">
                <i class="fas fa-sync-alt me-1"></i>Refresh Data
            </button>
        </div>
    </div>

    <!-- CE (Call) OI Changes -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-arrow-up me-2"></i>CE Top OI Increases
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Rank</th>
                                    <th>Strike</th>
                                    <th>OI Change</th>
                                    <th>Current OI</th>
                                    <th>LTP</th>
                                    <th>Time (IST)</th>
                                </tr>
                            </thead>
                            <tbody id="ceIncreases">
                                {% if oi_data and oi_data.ce_increases %}
                                    {% for record in oi_data.ce_increases[:3] %}
                                    <tr>
                                        <td>
                                            {% if loop.index == 1 %}
                                                <span class="badge bg-warning text-dark">1st</span>
                                            {% elif loop.index == 2 %}
                                                <span class="badge bg-secondary">2nd</span>
                                            {% elif loop.index == 3 %}
                                                <span class="badge bg-info text-dark">3rd</span>
                                            {% endif %}
                                        </td>
                                        <td><strong>{{ "%.0f"|format(record.strike_price) }}</strong></td>
                                        <td>
                                            <span class="text-success fw-bold">
                                                +{{ "{:,}".format(record.ce_oi_change|int) }}
                                            </span>
                                        </td>
                                        <td>{{ "{:,}".format(record.ce_oi|int) }}</td>
                                        <td>{{ "%.2f"|format(record.ce_ltp) }}</td>
                                        <td>{{ format_ist_time_only(record.timestamp) }}</td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">
                                            No significant CE OI increases found
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-arrow-down me-2"></i>CE Top OI Decreases
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Rank</th>
                                    <th>Strike</th>
                                    <th>OI Change</th>
                                    <th>Current OI</th>
                                    <th>LTP</th>
                                    <th>Time (IST)</th>
                                </tr>
                            </thead>
                            <tbody id="ceDecreases">
                                {% if oi_data and oi_data.ce_decreases %}
                                    {% for record in oi_data.ce_decreases[:3] %}
                                    <tr>
                                        <td>
                                            {% if loop.index == 1 %}
                                                <span class="badge bg-warning text-dark">1st</span>
                                            {% elif loop.index == 2 %}
                                                <span class="badge bg-secondary">2nd</span>
                                            {% elif loop.index == 3 %}
                                                <span class="badge bg-info text-dark">3rd</span>
                                            {% endif %}
                                        </td>
                                        <td><strong>{{ "%.0f"|format(record.strike_price) }}</strong></td>
                                        <td>
                                            <span class="text-danger fw-bold">
                                                {{ "{:,}".format(record.ce_oi_change|int) }}
                                            </span>
                                        </td>
                                        <td>{{ "{:,}".format(record.ce_oi|int) }}</td>
                                        <td>{{ "%.2f"|format(record.ce_ltp) }}</td>
                                        <td>{{ format_ist_time_only(record.timestamp) }}</td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">
                                            No significant CE OI decreases found
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PE (Put) OI Changes -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-arrow-up me-2"></i>PE Top OI Increases
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Rank</th>
                                    <th>Strike</th>
                                    <th>OI Change</th>
                                    <th>Current OI</th>
                                    <th>LTP</th>
                                    <th>Time (IST)</th>
                                </tr>
                            </thead>
                            <tbody id="peIncreases">
                                {% if oi_data and oi_data.pe_increases %}
                                    {% for record in oi_data.pe_increases[:3] %}
                                    <tr>
                                        <td>
                                            {% if loop.index == 1 %}
                                                <span class="badge bg-warning text-dark">1st</span>
                                            {% elif loop.index == 2 %}
                                                <span class="badge bg-secondary">2nd</span>
                                            {% elif loop.index == 3 %}
                                                <span class="badge bg-info text-dark">3rd</span>
                                            {% endif %}
                                        </td>
                                        <td><strong>{{ "%.0f"|format(record.strike_price) }}</strong></td>
                                        <td>
                                            <span class="text-success fw-bold">
                                                +{{ "{:,}".format(record.pe_oi_change|int) }}
                                            </span>
                                        </td>
                                        <td>{{ "{:,}".format(record.pe_oi|int) }}</td>
                                        <td>{{ "%.2f"|format(record.pe_ltp) }}</td>
                                        <td>{{ format_ist_time_only(record.timestamp) }}</td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">
                                            No significant PE OI increases found
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-arrow-down me-2"></i>PE Top OI Decreases
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Rank</th>
                                    <th>Strike</th>
                                    <th>OI Change</th>
                                    <th>Current OI</th>
                                    <th>LTP</th>
                                    <th>Time (IST)</th>
                                </tr>
                            </thead>
                            <tbody id="peDecreases">
                                {% if oi_data and oi_data.pe_decreases %}
                                    {% for record in oi_data.pe_decreases[:3] %}
                                    <tr>
                                        <td>
                                            {% if loop.index == 1 %}
                                                <span class="badge bg-warning text-dark">1st</span>
                                            {% elif loop.index == 2 %}
                                                <span class="badge bg-secondary">2nd</span>
                                            {% elif loop.index == 3 %}
                                                <span class="badge bg-info text-dark">3rd</span>
                                            {% endif %}
                                        </td>
                                        <td><strong>{{ "%.0f"|format(record.strike_price) }}</strong></td>
                                        <td>
                                            <span class="text-danger fw-bold">
                                                {{ "{:,}".format(record.pe_oi_change|int) }}
                                            </span>
                                        </td>
                                        <td>{{ "{:,}".format(record.pe_oi|int) }}</td>
                                        <td>{{ "%.2f"|format(record.pe_ltp) }}</td>
                                        <td>{{ format_ist_time_only(record.timestamp) }}</td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">
                                            No significant PE OI decreases found
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- OI Change Analysis Chart -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>OI Change Analysis - Timeline
                        </h5>
                        <button class="btn btn-sm btn-outline-light" id="refreshChartBtn" onclick="loadChartData()">
                            <i class="fas fa-sync-alt"></i> Refresh Chart
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="d-flex justify-content-center gap-4">
                                <div class="d-flex align-items-center">
                                    <div style="width: 20px; height: 3px; background-color: red; margin-right: 8px;"></div>
                                    <small><strong>Total CE OI Change</strong></small>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div style="width: 20px; height: 3px; background-color: green; margin-right: 8px;"></div>
                                    <small><strong>Total PE OI Change</strong></small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div style="position: relative; height: 400px;">
                                <canvas id="oiChangeChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12 text-center">
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> 
                                Chart shows cumulative OI changes from start of day
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Stats -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="border-end">
                                <h6 class="text-success">CE Increases</h6>
                                <span class="h4">{{ (oi_data.ce_increases|length) if oi_data else 0 }}</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border-end">
                                <h6 class="text-danger">CE Decreases</h6>
                                <span class="h4">{{ (oi_data.ce_decreases|length) if oi_data else 0 }}</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border-end">
                                <h6 class="text-success">PE Increases</h6>
                                <span class="h4">{{ (oi_data.pe_increases|length) if oi_data else 0 }}</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <h6 class="text-danger">PE Decreases</h6>
                            <span class="h4">{{ (oi_data.pe_decreases|length) if oi_data else 0 }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function refreshData() {
    const refreshBtn = document.querySelector('button[onclick="refreshData()"]');
    const originalHtml = refreshBtn.innerHTML;
    
    // Show loading state
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Refreshing...';
    refreshBtn.disabled = true;
    
    fetch('/api/oi-changes')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Update CE Increases
            updateTable('ceIncreases', data.ce_increases, 'ce');
            
            // Update CE Decreases
            updateTable('ceDecreases', data.ce_decreases, 'ce');
            
            // Update PE Increases
            updateTable('peIncreases', data.pe_increases, 'pe');
            
            // Update PE Decreases
            updateTable('peDecreases', data.pe_decreases, 'pe');
            
            // Update timestamp (already in IST from API)
            const istTime = new Date(data.last_updated);
            document.getElementById('lastUpdated').textContent = 
                istTime.toLocaleString('en-IN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                }) + ' IST';
            
        })
        .catch(error => {
            console.error('Error refreshing data:', error);
            alert('Error refreshing data: ' + error.message);
        })
        .finally(() => {
            // Reset button
            refreshBtn.innerHTML = originalHtml;
            refreshBtn.disabled = false;
        });
}

function updateTable(tableId, records, type) {
    const tbody = document.getElementById(tableId);
    
    if (!records || records.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted">
                    No significant ${type.toUpperCase()} OI changes found
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = '';
    
    records.slice(0, 3).forEach((record, index) => {
        const change = type === 'ce' ? record.oi_change : record.oi_change;
        const oi = type === 'ce' ? record.oi : record.oi;
        const ltp = type === 'ce' ? record.ltp : record.ltp;
        
        const isIncrease = change > 0;
        const changeClass = isIncrease ? 'text-success' : 'text-danger';
        const changePrefix = isIncrease ? '+' : '';
        
        let rankBadge = '';
        if (index === 0) rankBadge = '<span class="badge bg-warning text-dark">1st</span>';
        else if (index === 1) rankBadge = '<span class="badge bg-secondary">2nd</span>';
        else if (index === 2) rankBadge = '<span class="badge bg-info text-dark">3rd</span>';
        
        // Timestamp is already in IST from API
        const istTime = new Date(record.timestamp);
        const time = istTime.toLocaleTimeString('en-IN', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        });
        
        tbody.innerHTML += `
            <tr>
                <td>${rankBadge}</td>
                <td><strong>${record.strike.toFixed(0)}</strong></td>
                <td>
                    <span class="${changeClass} fw-bold">
                        ${changePrefix}${Math.abs(change).toLocaleString()}
                    </span>
                </td>
                <td>${oi.toLocaleString()}</td>
                <td>${ltp.toFixed(2)}</td>
                <td>${time}</td>
            </tr>
        `;
    });
}

// Chart functionality
let oiChangeChart = null;

function loadChartData() {
    const refreshBtn = document.getElementById('refreshChartBtn');
    const originalHtml = refreshBtn.innerHTML;
    
    // Show loading state
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
    refreshBtn.disabled = true;
    
    fetch('/api/oi-changes-timeline')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateChart(data.data);
            } else {
                throw new Error(data.error || 'Failed to load chart data');
            }
        })
        .catch(error => {
            console.error('Error loading chart data:', error);
            alert('Error loading chart data: ' + error.message);
        })
        .finally(() => {
            refreshBtn.innerHTML = originalHtml;
            refreshBtn.disabled = false;
        });
}

function updateChart(chartData) {
    const ctx = document.getElementById('oiChangeChart').getContext('2d');
    
    // Destroy existing chart if it exists
    if (oiChangeChart) {
        oiChangeChart.destroy();
    }
    
    oiChangeChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartData.labels,
            datasets: [
                {
                    label: 'Total CE OI Change',
                    data: chartData.ce_changes,
                    borderColor: 'red',
                    backgroundColor: 'rgba(255, 0, 0, 0.1)',
                    borderWidth: 2,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    tension: 0.1,
                    fill: false
                },
                {
                    label: 'Total PE OI Change',
                    data: chartData.pe_changes,
                    borderColor: 'green',
                    backgroundColor: 'rgba(0, 128, 0, 0.1)',
                    borderWidth: 2,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    tension: 0.1,
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                title: {
                    display: true,
                    text: 'NIFTY OI Changes Throughout the Day',
                    font: {
                        size: 16,
                        weight: 'bold'
                    }
                },
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        font: {
                            weight: 'bold'
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return `Time: ${context[0].label}`;
                        },
                        label: function(context) {
                            const value = context.parsed.y;
                            const formattedValue = Math.abs(value).toLocaleString();
                            const sign = value >= 0 ? '+' : '-';
                            return `${context.dataset.label}: ${sign}${formattedValue}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Time (IST)',
                        font: {
                            weight: 'bold',
                            size: 14
                        }
                    },
                    ticks: {
                        maxTicksLimit: 12 // Show max 12 time labels to avoid crowding
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Cumulative OI Change',
                        font: {
                            weight: 'bold',
                            size: 14
                        }
                    },
                    ticks: {
                        callback: function(value) {
                            // Format large numbers with K/M suffixes
                            if (Math.abs(value) >= 1000000) {
                                return (value / 1000000).toFixed(1) + 'M';
                            } else if (Math.abs(value) >= 1000) {
                                return (value / 1000).toFixed(1) + 'K';
                            }
                            return value.toLocaleString();
                        }
                    },
                    // Add a horizontal line at zero
                    grid: {
                        color: function(context) {
                            if (context.tick.value === 0) {
                                return 'rgba(0, 0, 0, 0.8)';
                            }
                            return 'rgba(0, 0, 0, 0.1)';
                        },
                        lineWidth: function(context) {
                            if (context.tick.value === 0) {
                                return 2;
                            }
                            return 1;
                        }
                    }
                }
            }
        }
    });
}

// Load chart data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadChartData();
});

// Auto-refresh every 2 minutes (both tables and chart)
setInterval(() => {
    refreshData();
    loadChartData();
}, 120000);
</script>

<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}
