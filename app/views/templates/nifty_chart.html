{% extends "base.html" %}

{% block title %}NIFTY Index Chart - Multi-Timeframe MACD Analysis{% endblock %}

{% block extra_css %}
<style>
.chart-header {
    background: linear-gradient(135deg, var(--kite-accent) 0%, #1F4E79 100%);
    color: var(--kite-text-main);
    padding: 2rem;
    border-radius: 15px;
    margin-bottom: 2rem;
    border: 1px solid var(--kite-border);
}

.chart-controls {
    background: var(--kite-card-bg);
    border: 1px solid var(--kite-border);
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.signal-card {
    background: linear-gradient(135deg, var(--kite-secondary) 0%, #0AA1DD 100%);
    border: 1px solid var(--kite-border);
    border-radius: 10px;
    color: var(--kite-text-main);
}

.buy-signal {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    font-weight: bold;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
}

.sell-signal {
    background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
    color: white;
    font-weight: bold;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
}

.neutral-signal {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
    font-weight: bold;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
}

.macd-values {
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
}

#tradingview_chart {
    height: 600px;
    border-radius: 10px;
    border: 1px solid var(--kite-border);
}

.signal-history {
    max-height: 400px;
    overflow-y: auto;
}

.signal-item {
    border-left: 4px solid transparent;
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    border-radius: 0 8px 8px 0;
}

.signal-item.buy {
    border-left-color: #28a745;
    background: rgba(40, 167, 69, 0.1);
}

.signal-item.sell {
    border-left-color: #dc3545;
    background: rgba(220, 53, 69, 0.1);
}

.price-change-positive {
    color: #28a745;
    font-weight: bold;
}

.price-change-negative {
    color: #dc3545;
    font-weight: bold;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Chart Header -->
    <div class="chart-header text-center">
        <div class="d-flex justify-content-between align-items-center">
            <a href="{{ url_for('market.dashboard') }}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
            <div>
                <h1 class="display-5 mb-2">
                    <i class="fas fa-chart-candlestick me-3"></i>NIFTY Index Chart
                </h1>
                <p class="lead mb-0">Multi-Timeframe MACD Analysis</p>
                <small>Real-time Buy/Sell Signals ‚Ä¢ MACD(12,26,9) ‚Ä¢ Default: 15-minute intervals</small>
            </div>
            <div>
                <button class="btn btn-outline-success me-2" onclick="refreshChart()" id="refreshBtn">
                    <i class="fas fa-sync-alt me-2"></i>Refresh Chart
                </button>
                <button class="btn btn-outline-info" onclick="showMACDInfo()" id="infoBtn">
                    <i class="fas fa-info-circle me-2"></i>MACD Info
                </button>
            </div>
        </div>
    </div>

    <!-- Current Status Row -->
    <div class="row mb-4">
        <!-- Current Price -->
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card signal-card text-white h-100">
                <div class="card-body text-center">
                    <h5 class="card-title">
                        <i class="fas fa-chart-line me-2"></i>NIFTY Current
                    </h5>
                    <h2 id="currentPrice">---.--</h2>
                    <small id="priceChange" class="price-change-neutral">-- (---%)</small>
                    <br><small id="lastUpdate">Last updated: --:--</small>
                </div>
            </div>
        </div>

        <!-- MACD Signal -->
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card h-100" id="macdSignalCard">
                <div class="card-body text-center">
                    <h5 class="card-title">
                        <i class="fas fa-chart-bar me-2"></i>MACD Signal
                    </h5>
                    <h2 id="macdSignal">NEUTRAL</h2>
                    <small id="signalStrength">Strength: --</small>
                </div>
            </div>
        </div>

        <!-- MACD Values -->
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card signal-card text-white h-100">
                <div class="card-body">
                    <h5 class="card-title text-center">
                        <i class="fas fa-calculator me-2"></i>MACD Values
                    </h5>
                    <div class="macd-values">
                        <div class="d-flex justify-content-between">
                            <span>MACD Line:</span>
                            <span id="macdLine">--</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Signal Line:</span>
                            <span id="signalLine">--</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Histogram:</span>
                            <span id="histogram">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Signal Stats -->
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card signal-card text-white h-100">
                <div class="card-body text-center">
                    <h5 class="card-title">
                        <i class="fas fa-chart-pie me-2"></i>Today's Signals
                    </h5>
                    <div class="row text-center">
                        <div class="col-6">
                            <h4 id="buySignalsCount" class="text-success">0</h4>
                            <small>Buy Signals</small>
                        </div>
                        <div class="col-6">
                            <h4 id="sellSignalsCount" class="text-danger">0</h4>
                            <small>Sell Signals</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart Container -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark text-white">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-candlestick me-2"></i>NIFTY Chart with MACD - <span id="currentTimeframe">15 Minutes</span>
                    </h5>
                    <div class="chart-controls d-flex align-items-center">
                        <div class="form-check form-switch me-3">
                            <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                            <label class="form-check-label text-white" for="autoRefresh">Auto Refresh</label>
                        </div>
                        <select class="form-select form-select-sm me-2" id="symbolSelect" onchange="changeSymbol()">
                            <option value="NIFTY" selected>NIFTY 50 Index</option>
                            <option value="BANKNIFTY">Bank NIFTY</option>
                            <option value="NIFTYIT">NIFTY IT</option>
                            <option value="NIFTYPHARMA">NIFTY Pharma</option>
                            <option value="NIFTYAUTO">NIFTY Auto</option>
                        </select>
                        <select class="form-select form-select-sm me-2" id="timeframeSelect" onchange="changeTimeframe()">
                            <option value="1">1 Minute</option>
                            <option value="3">3 Minutes</option>
                            <option value="5">5 Minutes</option>
                            <option value="10">10 Minutes</option>
                            <option value="15" selected>15 Minutes</option>
                            <option value="30">30 Minutes</option>
                            <option value="60">1 Hour</option>
                            <option value="240">4 Hours</option>
                            <option value="D">Daily</option>
                            <option value="W">Weekly</option>
                            <option value="M">Monthly</option>
                        </select>
                        <button class="btn btn-outline-warning btn-sm" onclick="debugChart()">
                            <i class="fas fa-bug me-1"></i>Debug
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="tradingview_chart"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Signal History and Analysis -->
    <div class="row">
        <div class="col-lg-8 mb-3">
            <div class="card bg-dark text-white">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>Recent MACD Signals
                    </h5>
                </div>
                <div class="card-body signal-history" id="signalHistory">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-spinner fa-spin me-2"></i>Loading signal history...
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4 mb-3">
            <div class="card bg-dark text-white">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>MACD Strategy Info
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6 class="text-success">üìà Buy Signal:</h6>
                        <small>
                            ‚Ä¢ MACD line crosses above Signal line<br>
                            ‚Ä¢ Histogram turns positive<br>
                            ‚Ä¢ Momentum is increasing
                        </small>
                    </div>
                    <div class="mb-3">
                        <h6 class="text-danger">üìâ Sell Signal:</h6>
                        <small>
                            ‚Ä¢ MACD line crosses below Signal line<br>
                            ‚Ä¢ Histogram turns negative<br>
                            ‚Ä¢ Momentum is decreasing
                        </small>
                    </div>
                    <div class="mb-3">
                        <h6 class="text-info">‚öôÔ∏è Parameters:</h6>
                        <small>
                            ‚Ä¢ Fast EMA: 12 periods<br>
                            ‚Ä¢ Slow EMA: 26 periods<br>
                            ‚Ä¢ Signal EMA: 9 periods<br>
                            ‚Ä¢ Timeframe: Flexible (1min to Monthly)
                        </small>
                    </div>
                    <div class="alert alert-warning">
                        <small>
                            <strong>Note:</strong> MACD is a trend-following momentum indicator. 
                            Use in conjunction with other analysis for best results.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Plotly.js for Python-based charting -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<script>
let refreshInterval;
let currentTimeframe = '15';

// Initialize Python-based Chart
function initChart() {
    console.log('üöÄ Initializing Python-based NIFTY chart...');
    
    // Check if Plotly is loaded
    if (typeof Plotly === 'undefined') {
        console.error('‚ùå Plotly.js is not loaded!');
        showChartError('Plotly.js library not loaded. Please refresh the page.');
        return;
    }
    
    console.log('‚úÖ Plotly.js is loaded, version:', Plotly.version);
    
    // Show loading state
    const container = document.getElementById('tradingview_chart');
    if (!container) {
        console.error('‚ùå Chart container #tradingview_chart not found!');
        return;
    }
    
    container.innerHTML = `
        <div class="d-flex justify-content-center align-items-center text-white" style="height: 600px; background: #1a1a1a;">
            <div class="text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5>Loading NIFTY Chart & MACD...</h5>
                <p>Generating candlestick chart with MACD analysis</p>
            </div>
        </div>
    `;
    
    // Load chart data from Python backend
    console.log('üì° Starting data load...');
    loadChartData();
}

// Load chart data from Python backend
async function loadChartData() {
    try {
        const timeframe = document.getElementById('timeframeSelect').value;
        const symbol = document.getElementById('symbolSelect').value || 'NIFTY';
        
        console.log(`üîÑ Loading chart data for ${symbol} with ${timeframe} minute timeframe`);
        
        // Fetch chart data from Python backend
        const response = await fetch(`/api/nifty-chart-data?timeframe=${timeframe}&symbol=${symbol}`, {
            method: 'GET',
            headers: {
                'Cache-Control': 'no-cache',
                'Content-Type': 'application/json'
            }
        });
        
        console.log(`üì° API Response Status: ${response.status}`);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('API Error Response:', errorText);
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const chartData = await response.json();
        console.log('üìä Chart data received:', chartData);
        console.log('Data structure:', {
            success: chartData.success,
            hasData: !!chartData.data,
            dataKeys: chartData.data ? Object.keys(chartData.data) : 'No data',
            timestampsLength: chartData.data?.timestamps?.length || 0
        });
        
        if (chartData.success && chartData.data) {
            console.log('‚úÖ Calling renderChart with data...');
            renderChart(chartData.data);
        } else {
            console.error('‚ùå Invalid chart data structure:', chartData);
            throw new Error(chartData.error || 'Failed to load chart data - invalid response structure');
        }
        
    } catch (error) {
        console.error('üí• Error loading chart data:', error);
        showChartError(`Chart Loading Failed: ${error.message}`);
    }
}

// Render chart using Plotly.js
function renderChart(data) {
    console.log('üé® Starting chart render with data:', data);
    
    const container = document.getElementById('tradingview_chart');
    
    if (!container) {
        console.error('‚ùå Chart container not found!');
        return;
    }
    
    try {
        // Validate data structure
        if (!data.timestamps || !Array.isArray(data.timestamps) || data.timestamps.length === 0) {
            throw new Error('Invalid or empty timestamps data');
        }
        
        console.log(`üìà Rendering chart with ${data.timestamps.length} data points`);
        
        // Prepare candlestick data
        const candlestickTrace = {
            x: data.timestamps,
            open: data.open,
            high: data.high,
            low: data.low,
            close: data.close,
            type: 'candlestick',
            name: 'NIFTY',
            increasing: {
                line: { color: '#26a69a' }
            },
            decreasing: {
                line: { color: '#ef5350' }
            },
            xaxis: 'x',
            yaxis: 'y'
        };
        
        // Prepare MACD data
        const macdTrace = {
            x: data.timestamps,
            y: data.macd_line,
            type: 'scatter',
            mode: 'lines',
            name: 'MACD Line',
            line: { color: '#00bcd4', width: 2 },
            xaxis: 'x',
            yaxis: 'y2'
        };
        
        const signalTrace = {
            x: data.timestamps,
            y: data.signal_line,
            type: 'scatter',
            mode: 'lines',
            name: 'Signal Line',
            line: { color: '#ff9800', width: 2 },
            xaxis: 'x',
            yaxis: 'y2'
        };
        
        const histogramTrace = {
            x: data.timestamps,
            y: data.histogram,
            type: 'bar',
            name: 'MACD Histogram',
            marker: {
                color: data.histogram.map(val => val >= 0 ? '#4caf50' : '#f44336')
            },
            xaxis: 'x',
            yaxis: 'y2'
        };
        
        // Layout configuration
        const layout = {
            title: {
                text: `NIFTY ${currentTimeframe} Minutes Chart with MACD`,
                font: { color: '#ffffff', size: 16 }
            },
            paper_bgcolor: '#1a1a1a',
            plot_bgcolor: '#1a1a1a',
            font: { color: '#ffffff' },
            showlegend: true,
            legend: {
                x: 0,
                y: 1,
                bgcolor: 'rgba(0,0,0,0.5)'
            },
            xaxis: {
                domain: [0, 1],
                anchor: 'y2',
                gridcolor: '#444444',
                color: '#ffffff'
            },
            yaxis: {
                domain: [0.3, 1],
                title: 'Price (‚Çπ)',
                gridcolor: '#444444',
                color: '#ffffff'
            },
            yaxis2: {
                domain: [0, 0.25],
                title: 'MACD',
                gridcolor: '#444444',
                color: '#ffffff'
            },
            margin: { l: 60, r: 40, t: 60, b: 40 }
        };
        
        const config = {
            responsive: true,
            displayModeBar: true,
            modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
            displaylogo: false
        };
        
        // Clear container and render chart
        console.log('üèóÔ∏è Clearing container and rendering with Plotly...');
        container.innerHTML = '';
        
        console.log('üìä Plotly traces prepared:', {
            candlestick: !!candlestickTrace,
            macd: !!macdTrace,
            signal: !!signalTrace,
            histogram: !!histogramTrace
        });
        
        Plotly.newPlot(container, [candlestickTrace, macdTrace, signalTrace, histogramTrace], layout, config)
            .then(() => {
                console.log('‚úÖ Python-based chart rendered successfully');
                // Update current timeframe display
                document.getElementById('currentTimeframe').textContent = `${currentTimeframe} Minutes`;
            })
            .catch((plotlyError) => {
                console.error('üí• Plotly rendering error:', plotlyError);
                showChartError(`Plotly Error: ${plotlyError.message}`);
            });
        
    } catch (error) {
        console.error('üí• Error in renderChart function:', error);
        showChartError(`Render Error: ${error.message}`);
    }
}

// Show chart error
function showChartError(errorMessage) {
    const container = document.getElementById('tradingview_chart');
    container.innerHTML = `
        <div class="d-flex justify-content-center align-items-center text-white" style="height: 600px; background: #1a1a1a;">
            <div class="text-center">
                <i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i>
                <h5>Chart Loading Error</h5>
                <p>${errorMessage}</p>
                <button onclick="initChart()" class="btn btn-primary">
                    <i class="fas fa-sync-alt me-2"></i>Retry
                </button>
            </div>
        </div>
    `;
}

// Refresh chart
function refreshChart() {
    const refreshBtn = document.getElementById('refreshBtn');
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Refreshing...';
    
    // Refresh current price data
    refreshCurrentData();
    
    // Refresh MACD signals
    refreshMACDSignals();
    
    setTimeout(() => {
        refreshBtn.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Refresh Chart';
    }, 2000);
}

// Refresh current price and MACD data
async function refreshCurrentData() {
    try {
        // Get current NIFTY price
        const response = await fetch('/api/current-nifty');
        const data = await response.json();
        
        if (data.price) {
            document.getElementById('currentPrice').textContent = data.price.toFixed(2);
            
            // Calculate price change
            const change = data.change || 0;
            const changePercent = data.change_percent || 0;
            const changeElement = document.getElementById('priceChange');
            
            if (change >= 0) {
                changeElement.textContent = `+${change.toFixed(2)} (+${changePercent.toFixed(2)}%)`;
                changeElement.className = 'price-change-positive';
            } else {
                changeElement.textContent = `${change.toFixed(2)} (${changePercent.toFixed(2)}%)`;
                changeElement.className = 'price-change-negative';
            }
            
            // Update last update time
            const now = new Date();
            document.getElementById('lastUpdate').textContent = `Last updated: ${now.toLocaleTimeString('en-IN', {timeZone: 'Asia/Kolkata'})}`;
        }
        
        // Get real MACD data from backend
        await refreshMACDData();
        
    } catch (error) {
        console.error('Error refreshing current data:', error);
    }
}

// Get real MACD data from backend
async function refreshMACDData() {
    try {
        const timeframe = document.getElementById('timeframeSelect').value;
        console.log('Fetching MACD data for timeframe:', timeframe);
        
        // Get MACD analysis with error handling
        const macdResponse = await fetch(`/api/macd-analysis?timeframe=${timeframe}`, {
            method: 'GET',
            headers: {
                'Cache-Control': 'no-cache'
            }
        });
        
        if (!macdResponse.ok) {
            throw new Error(`HTTP error! status: ${macdResponse.status}`);
        }
        
        const macdData = await macdResponse.json();
        console.log('MACD response:', macdData);
        
        if (macdData.success && macdData.macd_data) {
            const macd = macdData.macd_data;
            
            // Update MACD values
            document.getElementById('macdLine').textContent = macd.macd_line.toFixed(2);
            document.getElementById('signalLine').textContent = macd.signal_line.toFixed(2);
            document.getElementById('histogram').textContent = macd.histogram.toFixed(2);
            
            // Determine signal and styling
            let signal, signalClass;
            const signalCard = document.getElementById('macdSignalCard');
            
            switch(macd.signal) {
                case 'BUY':
                    signal = 'BUY';
                    signalClass = 'buy-signal';
                    break;
                case 'SELL':
                    signal = 'SELL';
                    signalClass = 'sell-signal';
                    break;
                case 'BULLISH':
                    signal = 'BULLISH';
                    signalClass = 'buy-signal';
                    break;
                case 'BEARISH':
                    signal = 'BEARISH';
                    signalClass = 'sell-signal';
                    break;
                default:
                    signal = 'NEUTRAL';
                    signalClass = 'neutral-signal';
            }
            
            document.getElementById('macdSignal').textContent = signal;
            document.getElementById('signalStrength').textContent = `Strength: ${macd.strength || 'Unknown'}`;
            signalCard.className = `card h-100 ${signalClass}`;
            
            // Update signal history
            updateSignalHistory(macdData.signal_history || []);
        }
        
        // Get signal statistics
        const statsResponse = await fetch('/api/signal-stats');
        const statsData = await statsResponse.json();
        
        if (statsData.success) {
            document.getElementById('buySignalsCount').textContent = statsData.stats.buy_signals_today;
            document.getElementById('sellSignalsCount').textContent = statsData.stats.sell_signals_today;
        }
        
    } catch (error) {
        console.error('Error refreshing MACD data:', error);
        
        // Show error state in UI
        document.getElementById('macdLine').textContent = 'Error';
        document.getElementById('signalLine').textContent = 'Error';
        document.getElementById('histogram').textContent = 'Error';
        document.getElementById('macdSignal').textContent = 'ERROR';
        document.getElementById('signalStrength').textContent = 'Data unavailable';
        document.getElementById('macdSignalCard').className = 'card h-100 neutral-signal';
    }
}

// Alias for refreshMACDData for chart callback
function loadMACDData() {
    refreshMACDData();
}

// Update signal history display
function updateSignalHistory(signals) {
    const signalHistory = document.getElementById('signalHistory');
    
    if (!signals || signals.length === 0) {
        signalHistory.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-info-circle me-2"></i>No recent MACD signals available
            </div>
        `;
        return;
    }
    
    let html = '';
    signals.forEach(signal => {
        const iconClass = signal.type === 'buy' ? 'fa-arrow-up text-success' : 'fa-arrow-down text-danger';
        html += `
            <div class="signal-item ${signal.type}">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas ${iconClass} me-2"></i>
                        <strong>${signal.type.toUpperCase()}</strong> Signal
                        <small class="text-muted">(${signal.strength})</small>
                    </div>
                    <div class="text-end">
                        <div><strong>‚Çπ${signal.price}</strong></div>
                        <small class="text-muted">${signal.timestamp}</small>
                    </div>
                </div>
                <small class="text-muted">
                    MACD: ${signal.macd_value}, Signal: ${signal.signal_value}, 
                    Histogram: ${signal.histogram}
                </small>
            </div>
        `;
    });
    
    signalHistory.innerHTML = html;
}

// Refresh MACD signals (now calls the backend)
async function refreshMACDSignals() {
    try {
        await refreshMACDData();
    } catch (error) {
        console.error('Error refreshing MACD signals:', error);
        const signalHistory = document.getElementById('signalHistory');
        signalHistory.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-exclamation-triangle me-2"></i>Error loading signal data
            </div>
        `;
    }
}

// Change timeframe
function changeTimeframe() {
    const timeframe = document.getElementById('timeframeSelect').value;
    const timeframeSelect = document.getElementById('timeframeSelect');
    const selectedText = timeframeSelect.options[timeframeSelect.selectedIndex].text;
    
    // Update the current timeframe display and global variable
    document.getElementById('currentTimeframe').textContent = selectedText;
    currentTimeframe = timeframe;
    
    console.log(`Changing timeframe to ${timeframe} minutes`);
    
    // Reload chart with new timeframe
    loadChartData();
    
    // Also refresh MACD data
    setTimeout(() => {
        loadMACDData();
    }, 1000);
}

// Change symbol
function changeSymbol() {
    const symbol = document.getElementById('symbolSelect').value;
    console.log(`Changing symbol to ${symbol}`);
    
    // Reload chart with new symbol
    loadChartData();
    
    // Also refresh MACD data
    setTimeout(() => {
        loadMACDData();
    }, 1000);
}

// Show MACD info modal
function showMACDInfo() {
    alert(`MACD (Moving Average Convergence Divergence) Information:

üìä How it works:
- MACD Line = 12-period EMA - 26-period EMA
- Signal Line = 9-period EMA of MACD Line
- Histogram = MACD Line - Signal Line

üìà Buy Signals:
- MACD line crosses above Signal line (Bullish crossover)
- Histogram turns positive
- MACD moves from negative to positive territory

üìâ Sell Signals:
- MACD line crosses below Signal line (Bearish crossover)
- Histogram turns negative
- MACD moves from positive to negative territory

‚ö†Ô∏è Best Practices:
- Use with other indicators for confirmation
- Works best in trending markets
- Can give false signals in sideways markets
- Consider overall market sentiment`);
}

// Debug function
function debugChart() {
    console.log('üêõ DEBUG: Checking chart status...');
    
    // Check DOM elements
    console.log('Chart container exists:', !!document.getElementById('tradingview_chart'));
    console.log('Timeframe select exists:', !!document.getElementById('timeframeSelect'));
    console.log('Symbol select exists:', !!document.getElementById('symbolSelect'));
    
    // Check Plotly
    console.log('Plotly available:', typeof Plotly !== 'undefined');
    if (typeof Plotly !== 'undefined') {
        console.log('Plotly version:', Plotly.version);
    }
    
    // Check current values
    console.log('Current timeframe:', document.getElementById('timeframeSelect')?.value);
    console.log('Current symbol:', document.getElementById('symbolSelect')?.value);
    console.log('Current timeframe var:', currentTimeframe);
    
    // Test basic Plotly functionality
    console.log('üß™ Testing basic Plotly rendering...');
    const container = document.getElementById('tradingview_chart');
    
    if (container && typeof Plotly !== 'undefined') {
        // Create a simple test chart
        const testData = [{
            x: ['2025-01-01', '2025-01-02', '2025-01-03'],
            y: [100, 200, 150],
            type: 'scatter',
            mode: 'lines',
            name: 'Test Line'
        }];
        
        const testLayout = {
            title: 'Test Chart - If you see this, Plotly works!',
            paper_bgcolor: '#1a1a1a',
            plot_bgcolor: '#1a1a1a',
            font: { color: '#ffffff' }
        };
        
        Plotly.newPlot(container, testData, testLayout)
            .then(() => {
                console.log('‚úÖ Basic Plotly test successful!');
                console.log('üöÄ Now trying real data...');
                setTimeout(loadChartData, 2000);
            })
            .catch(error => {
                console.error('‚ùå Basic Plotly test failed:', error);
            });
    } else {
        console.log('üöÄ Force loading chart data anyway...');
        loadChartData();
    }
}

// Simple force load function
function forceLoadChart() {
    console.log('üöÄ FORCE: Starting chart load...');
    
    const container = document.getElementById('tradingview_chart');
    if (!container) {
        console.error('‚ùå FORCE: Chart container not found');
        return;
    }
    
    console.log('üìä FORCE: Making API call...');
    fetch('/api/nifty-chart-data?timeframe=15&symbol=NIFTY')
        .then(response => {
            console.log('üì° FORCE: API response received');
            return response.json();
        })
        .then(data => {
            console.log('üìä FORCE: Data received, rendering...');
            if (data.success && data.data) {
                renderChart(data.data);
            } else {
                console.error('‚ùå FORCE: Invalid data');
            }
        })
        .catch(error => {
            console.error('üí• FORCE: API error:', error);
        });
}

// Wait for everything to load then initialize
function waitForPlotlyAndInit() {
    console.log('‚è≥ Waiting for Plotly to load...');
    
    if (typeof Plotly !== 'undefined') {
        console.log('‚úÖ Plotly loaded, trying simple approach...');
        try {
            // Use simple force load instead of complex init
            forceLoadChart();
        } catch (error) {
            console.error('üí• Error in forceLoadChart:', error);
        }
    } else {
        console.log('‚è≥ Plotly not ready, retrying in 500ms...');
        setTimeout(waitForPlotlyAndInit, 500);
    }
}

// Initialize page  
document.addEventListener('DOMContentLoaded', function() {
    console.log('üåü DOM Content Loaded - Starting initialization...');
    
    try {
        // Wait for Plotly to load, then initialize
        waitForPlotlyAndInit();
        
        // Set up auto-refresh (without dependencies)
        setTimeout(() => {
            try {
                refreshInterval = setInterval(() => {
                    try {
                        if (document.getElementById('autoRefresh') && document.getElementById('autoRefresh').checked) {
                            console.log('üîÑ Auto-refreshing...');
                            if (document.getElementById('currentPrice')) {
                                refreshCurrentData().catch(e => console.error('Auto-refresh error:', e));
                            }
                        }
                    } catch (refreshError) {
                        console.error('üí• Auto-refresh error:', refreshError);
                    }
                }, 30000); // Refresh every 30 seconds
            } catch (intervalError) {
                console.error('üí• Interval setup error:', intervalError);
            }
        }, 2000);
        
        console.log('‚úÖ Event listeners setup complete!');
    } catch (domError) {
        console.error('üí• DOM initialization error:', domError);
    }
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
    if (chart) {
        chart.remove();
    }
});
</script>
{% endblock %}
