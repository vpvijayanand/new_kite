{% extends "base.html" %}

{% block title %}Enhanced Market Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="mb-4">ðŸ“ˆ Advanced Market Dashboard</h1>
    </div>
</div>

<!-- Price Cards -->
<div class="row mb-4">
    <!-- Nifty 50 Card -->
    <div class="col-md-6">
        <div class="card border-primary">
            <div class="card-body">
                <h5 class="card-title d-flex align-items-center">
                    <i class="fas fa-chart-line me-2"></i>NIFTY 50
                </h5>
                <h2 class="text-primary" id="niftyPrice">
                    {% if nifty_price %}
                        {{ "%.2f"|format(nifty_price.price) }}
                    {% else %}
                        Loading...
                    {% endif %}
                </h2>
                <p class="mb-1">
                    <span id="niftyChange" class="badge {% if nifty_price and nifty_price.change >= 0 %}bg-success{% else %}bg-danger{% endif %}">
                        {% if nifty_price %}
                            {{ "%.2f"|format(nifty_price.change) }} ({{ "%.2f"|format(nifty_price.change_percent) }}%)
                        {% else %}
                            --
                        {% endif %}
                    </span>
                </p>
                <p class="text-muted small" id="niftyUpdate">
                    {% if nifty_price %}
                        Last updated: {{ format_ist_time(nifty_price.timestamp) }}
                    {% else %}
                        --
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
    
    <!-- Bank Nifty Card -->
    <div class="col-md-6">
        <div class="card border-success">
            <div class="card-body">
                <h5 class="card-title d-flex align-items-center">
                    <i class="fas fa-university me-2"></i>BANK NIFTY
                </h5>
                <h2 class="text-success" id="bankniftyPrice">
                    {% if banknifty_price %}
                        {{ "%.2f"|format(banknifty_price.price) }}
                    {% else %}
                        Loading...
                    {% endif %}
                </h2>
                <p class="mb-1">
                    <span id="bankniftyChange" class="badge {% if banknifty_price and banknifty_price.change >= 0 %}bg-success{% else %}bg-danger{% endif %}">
                        {% if banknifty_price %}
                            {{ "%.2f"|format(banknifty_price.change) }} ({{ "%.2f"|format(banknifty_price.change_percent) }}%)
                        {% else %}
                            --
                        {% endif %}
                    </span>
                </p>
                <p class="text-muted small" id="bankniftyUpdate">
                    {% if banknifty_price %}
                        Last updated: {{ format_ist_time(banknifty_price.timestamp) }}
                    {% else %}
                        --
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Market Trend Analysis -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>NIFTY Market Sentiment</h5>
            </div>
            <div class="card-body">
                {% if nifty_trend %}
                <div class="row text-center">
                    <div class="col-4">
                        <h6 class="text-success">Bullish</h6>
                        <h3 class="text-success">{{ "%.1f"|format(nifty_trend.bullish_percentage) }}%</h3>
                    </div>
                    <div class="col-4">
                        <h6 class="text-danger">Bearish</h6>
                        <h3 class="text-danger">{{ "%.1f"|format(nifty_trend.bearish_percentage) }}%</h3>
                    </div>
                    <div class="col-4">
                        <h6 class="text-muted">PCR</h6>
                        <h3 class="text-info">{{ "%.2f"|format(nifty_trend.pcr_oi) }}</h3>
                    </div>
                </div>
                <hr>
                <small class="text-muted">
                    Max Pain: {{ "%.0f"|format(nifty_trend.max_pain_strike) }} | 
                    Support: {{ "%.0f"|format(nifty_trend.key_support_level) }} |
                    Resistance: {{ "%.0f"|format(nifty_trend.key_resistance_level) }}
                </small>
                {% else %}
                <p class="text-muted">Loading market sentiment...</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>BANKNIFTY Market Sentiment</h5>
            </div>
            <div class="card-body">
                {% if banknifty_trend %}
                <div class="row text-center">
                    <div class="col-4">
                        <h6 class="text-success">Bullish</h6>
                        <h3 class="text-success">{{ "%.1f"|format(banknifty_trend.bullish_percentage) }}%</h3>
                    </div>
                    <div class="col-4">
                        <h6 class="text-danger">Bearish</h6>
                        <h3 class="text-danger">{{ "%.1f"|format(banknifty_trend.bearish_percentage) }}%</h3>
                    </div>
                    <div class="col-4">
                        <h6 class="text-muted">PCR</h6>
                        <h3 class="text-info">{{ "%.2f"|format(banknifty_trend.pcr_oi) }}</h3>
                    </div>
                </div>
                <hr>
                <small class="text-muted">
                    Max Pain: {{ "%.0f"|format(banknifty_trend.max_pain_strike) }} | 
                    Support: {{ "%.0f"|format(banknifty_trend.key_support_level) }} |
                    Resistance: {{ "%.0f"|format(banknifty_trend.key_resistance_level) }}
                </small>
                {% else %}
                <p class="text-muted">Loading market sentiment...</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions and Navigation -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-tools me-2"></i>Quick Actions</h5>
                <div class="row">
                    <div class="col-md-3">
                        <button class="btn btn-primary w-100" id="refreshBtn">
                            <i class="fas fa-sync me-2"></i>Refresh All Data
                        </button>
                    </div>
                    <div class="col-md-3">
                        <a href="/option-chain?underlying=NIFTY" class="btn btn-warning w-100">
                            <i class="fas fa-chart-bar me-2"></i>NIFTY Option Chain
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="/option-chain?underlying=BANKNIFTY" class="btn btn-info w-100">
                            <i class="fas fa-chart-bar me-2"></i>BANKNIFTY Option Chain
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="/oi-analysis?underlying=NIFTY" class="btn btn-secondary w-100">
                            <i class="fas fa-analytics me-2"></i>OI Analysis
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Option Chain Summary -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-list me-2"></i>NIFTY Option Chain Preview</h5>
            </div>
            <div class="card-body">
                {% if nifty_options_summary %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Strike</th>
                                <th>CE OI</th>
                                <th>PE OI</th>
                                <th>Total OI</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for option in nifty_options_summary %}
                            <tr>
                                <td><strong>{{ "%.0f"|format(option.strike_price) }}</strong></td>
                                <td class="text-success">{{ "{:,}"|format(option.ce_data.oi) }}</td>
                                <td class="text-danger">{{ "{:,}"|format(option.pe_data.oi) }}</td>
                                <td>{{ "{:,}"|format(option.ce_data.oi + option.pe_data.oi) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="text-center mt-3">
                    <a href="/option-chain?underlying=NIFTY" class="btn btn-sm btn-primary">View Full Chain</a>
                </div>
                {% else %}
                <p class="text-muted">No option chain data available. Please refresh to fetch latest data.</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-list me-2"></i>BANKNIFTY Option Chain Preview</h5>
            </div>
            <div class="card-body">
                {% if banknifty_options_summary %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Strike</th>
                                <th>CE OI</th>
                                <th>PE OI</th>
                                <th>Total OI</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for option in banknifty_options_summary %}
                            <tr>
                                <td><strong>{{ "%.0f"|format(option.strike_price) }}</strong></td>
                                <td class="text-success">{{ "{:,}"|format(option.ce_data.oi) }}</td>
                                <td class="text-danger">{{ "{:,}"|format(option.pe_data.oi) }}</td>
                                <td>{{ "{:,}"|format(option.ce_data.oi + option.pe_data.oi) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="text-center mt-3">
                    <a href="/option-chain?underlying=BANKNIFTY" class="btn btn-sm btn-success">View Full Chain</a>
                </div>
                {% else %}
                <p class="text-muted">No option chain data available. Please refresh to fetch latest data.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Auto Refresh Status -->
<div class="row">
    <div class="col-md-12">
        <div class="card border-light">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-info-circle me-2 text-info"></i>
                        <strong>Auto Refresh:</strong> Data is automatically updated every minute
                    </div>
                    <div>
                        <span class="badge bg-success" id="connectionStatus">Connected</span>
                        <small class="text-muted ms-2" id="lastRefresh">Just now</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script>
// Enhanced Dashboard JavaScript
document.addEventListener('DOMContentLoaded', function() {
    const refreshBtn = document.getElementById('refreshBtn');
    const connectionStatus = document.getElementById('connectionStatus');
    const lastRefresh = document.getElementById('lastRefresh');
    
    // Manual refresh function
    refreshBtn.addEventListener('click', function() {
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Refreshing...';
        refreshBtn.disabled = true;
        
        fetch('/fetch-now')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Reload the page to show updated data
                location.reload();
            } else {
                alert('Error refreshing data: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error refreshing data');
        })
        .finally(() => {
            refreshBtn.innerHTML = '<i class="fas fa-sync me-2"></i>Refresh All Data';
            refreshBtn.disabled = false;
        });
    });
    
    // Auto refresh every 30 seconds
    setInterval(function() {
        fetch('/api/dashboard-data')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateDashboardData(data.data);
                connectionStatus.className = 'badge bg-success';
                connectionStatus.textContent = 'Connected';
                lastRefresh.textContent = 'Just now';
            }
        })
        .catch(error => {
            console.error('Auto refresh error:', error);
            connectionStatus.className = 'badge bg-danger';
            connectionStatus.textContent = 'Disconnected';
        });
    }, 30000);
    
    function updateDashboardData(data) {
        // Update prices if available
        if (data.nifty_price) {
            document.getElementById('niftyPrice').textContent = parseFloat(data.nifty_price.price).toFixed(2);
        }
        if (data.banknifty_price) {
            document.getElementById('bankniftyPrice').textContent = parseFloat(data.banknifty_price.price).toFixed(2);
        }
    }
});
</script>
{% endblock %}